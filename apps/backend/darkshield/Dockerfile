FROM golang:1.22-alpine AS builder

ARG KEYCLOAK_HOST
ARG KEYCLOAK_CLIENT_ID
ARG KEYCLOAK_CLIENT_SECRET
ARG KEYCLOAK_REALM

ENV KEYCLOAK_HOST=$KEYCLOAK_HOST
ENV KEYCLOAK_CLIENT_ID=$KEYCLOAK_CLIENT_ID
ENV KEYCLOAK_CLIENT_SECRET=$KEYCLOAK_CLIENT_SECRET
ENV KEYCLOAK_REALM=$KEYCLOAK_REALM

WORKDIR /app

COPY go.mod go.sum ./

RUN go mod download

COPY . .

ENV GOCACHE=/root/.cache/go-build

RUN --mount=type=cache,target="/root/.cache/go-build" CGO_ENABLED=0 GOOS=linux go build -o darkshield

FROM alpine:edge AS runner

RUN apk add --no-cache dumb-init

ARG KEYCLOAK_HOST
ARG KEYCLOAK_CLIENT_ID
ARG KEYCLOAK_CLIENT_SECRET
ARG KEYCLOAK_REALM

ENV KEYCLOAK_HOST=$KEYCLOAK_HOST
ENV KEYCLOAK_CLIENT_ID=$KEYCLOAK_CLIENT_ID
ENV KEYCLOAK_CLIENT_SECRET=$KEYCLOAK_CLIENT_SECRET
ENV KEYCLOAK_REALM=$KEYCLOAK_REALM

WORKDIR /darkshield

COPY --from=builder /app/darkshield .

ENTRYPOINT ["dumb-init", "--"]

CMD ["./darkshield"]
